---
layout: post
title: "Understanding Attention Mechanism: Self-Attention and Attention Models"
date: 2024-07-26 11:39 +0800
categories: [AI, Large Language Models]
tags: [Machine Learning, LLM]
math: true
image:
  path: https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407151855074.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸï¼Œæ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttention Mechanismï¼‰å·²ç»æˆä¸ºæå‡æ¨¡å‹æ€§èƒ½çš„é‡è¦å·¥å…·ã€‚**ä¼ ç»Ÿçš„Encoder-Decoderç»“æ„åœ¨å¤„ç†é•¿åºåˆ—æ—¶ï¼Œå¸¸å¸¸å› ä¸ºç»Ÿä¸€è¯­ä¹‰ç‰¹å¾å‘é‡çš„é•¿åº¦é™åˆ¶è€Œå¯¼è‡´æ€§èƒ½ç“¶é¢ˆ**ã€‚ç„¶è€Œï¼Œæ³¨æ„åŠ›æœºåˆ¶é€šè¿‡å¼•å…¥åŠ¨æ€ä¸Šä¸‹æ–‡å‘é‡ï¼ŒæˆåŠŸè§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨æ¯ä¸ªæ—¶é—´æ­¥é€‰æ‹©ä¸å½“å‰è¾“å‡ºæœ€ç›¸å…³çš„ä¿¡æ¯ã€‚

> æœ¬ç¯‡åšå®¢å°†è¯¦ç»†ä»‹ç»æ³¨æ„åŠ›æœºåˆ¶çš„åŸºæœ¬åŸç†ã€ä¸€èˆ¬å½¢å¼ä»¥åŠè‡ªæ³¨æ„åŠ›æ¨¡å‹ï¼Œå¹¶é€šè¿‡å…·ä½“ä¾‹å­å’Œå›¾ç¤ºæ¥æ›´å¥½åœ°ç†è§£è¿™äº›å…³é”®æ¦‚å¿µã€‚
> {: .prompt-tip}

## ä¸€ã€è¯­è¨€æ¨¡å‹å®ä¾‹

åœ¨Encoder-Decoderç»“æ„ä¸­ï¼ŒEncoderæŠŠæ‰€æœ‰çš„è¾“å…¥åºåˆ—éƒ½ç¼–ç æˆä¸€ä¸ªç»Ÿä¸€çš„è¯­ä¹‰ç‰¹å¾cå†è§£ç ï¼š

![æˆªå±2022-06-02 ä¸‹åˆ8.26.20](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202405262030938.png)

**å› æ­¤ï¼Œ cä¸­å¿…é¡»åŒ…å«åŸå§‹åºåˆ—ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå®ƒçš„é•¿åº¦å°±æˆäº†é™åˆ¶æ¨¡å‹æ€§èƒ½çš„ç“¶é¢ˆ**ã€‚å¦‚æœºå™¨ç¿»è¯‘é—®é¢˜ï¼Œå½“è¦ç¿»è¯‘çš„å¥å­è¾ƒé•¿æ—¶ï¼Œä¸€ä¸ªcå¯èƒ½å­˜ä¸ä¸‹é‚£ä¹ˆå¤šä¿¡æ¯ï¼Œå°±ä¼šé€ æˆç¿»è¯‘ç²¾åº¦çš„ä¸‹é™ã€‚

**Attentionæœºåˆ¶**é€šè¿‡åœ¨æ¯ä¸ªæ—¶é—´è¾“å…¥ä¸åŒçš„cæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸‹å›¾æ˜¯å¸¦æœ‰Attentionæœºåˆ¶çš„Decoderï¼š

![æˆªå±2022-06-02 ä¸‹åˆ8.37.47](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202405281637491.png)

æ¯ä¸€ä¸ªcä¼šè‡ªåŠ¨å»é€‰å–ä¸å½“å‰æ‰€è¦è¾“å‡ºçš„yæœ€åˆé€‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å…·ä½“æ¥è¯´:

1. ç”¨ $a_{i j}$ è¡¡é‡ Encoderä¸­ç¬¬jé˜¶æ®µçš„$h_j$å’Œè§£ç æ—¶ç¬¬ié˜¶æ®µçš„ç›¸å…³æ€§;
2. æœ€ç»ˆDecoderä¸­ç¬¬ié˜¶æ®µçš„è¾“å…¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ $c_{i}$ å°±æ¥è‡ªäºæ‰€æœ‰ $h_{j}$ å¯¹ $a_{i j}$ çš„åŠ æƒå’Œã€‚

ä»¥æœºå™¨ç¿»è¯‘ä¸ºä¾‹ï¼ˆå°†ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡ï¼‰ï¼š

![æˆªå±2022-06-02 ä¸‹åˆ8.42.38](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202405281637341.png)

è¾“å…¥çš„åºåˆ—æ˜¯â€œæˆ‘çˆ±ä¸­å›½â€:

1. å› æ­¤, Encoderä¸­çš„h1ã€h2ã€h3ã€h4å°±å¯ä»¥åˆ†åˆ«çœ‹åšæ˜¯â€œæˆ‘â€ã€ â€œçˆ±â€ã€â€œä¸­â€ã€â€œå›½â€æ‰€ä»£è¡¨çš„ä¿¡æ¯;
2. åœ¨ç¿»è¯‘æˆè‹±è¯­æ—¶, ç¬¬ä¸€ä¸ªä¸Šä¸‹æ–‡$c_1$åº”è¯¥å’Œâ€œæˆ‘â€è¿™ä¸ªå­—æœ€ç›¸å…³, å› æ­¤å¯¹åº”çš„ $a_{11}$ å°±æ¯”è¾ƒå¤§, è€Œç›¸åº”çš„ $a_{12} ã€ a_{13} ã€ a_{14}$ å°±æ¯”è¾ƒå°;
3. c2åº”è¯¥å’Œâ€œçˆ±â€æœ€ç›¸å…³, å› æ­¤å¯¹åº”çš„ $a_{22}$ å°±æ¯”è¾ƒå¤§;
4. æœ€åçš„$c_3$å’Œ$h_3ã€h_4$æœ€ç›¸å…³, å› æ­¤ $a_{33} ã€ a_{34}$ çš„å€¼å°±æ¯”è¾ƒå¤§ã€‚

è¿™äº›æƒé‡ $a_{i j}$ æ˜¯æ€ä¹ˆæ¥çš„?äº‹å®ä¸Š, $a_{i j}$ åŒæ ·æ˜¯ä»æ¨¡å‹ä¸­å­¦å‡ºçš„, å®ƒå®é™…å’ŒDecoderçš„ç¬¬ié˜¶æ®µçš„éšçŠ¶æ€ã€Encoderç¬¬jä¸ªé˜¶æ®µçš„éšçŠ¶æ€æœ‰å…³ï¼Œåœ¨ä¸‹é¢ä¸€å°èŠ‚æˆ‘ä»¬ä¼šä»‹ç»$a_{ij}$å¦‚ä½•è®¡ç®—.

- è¿™é‡Œçš„$c_1,c_2,c_3$å°±æ˜¯**attentionå€¼**;

## äºŒã€ä¸€èˆ¬æ¨¡å‹

åˆšåˆšæˆ‘ä»¬æ˜¯åŸºäºEncoder-Decoderæ¨¡å‹æ¥ä»‹ç»attentionæœºåˆ¶çš„ï¼Œä¸‹é¢æˆ‘ä»¬æ›´ä¸€èˆ¬çš„æ¥ä»‹ç»æ³¨æ„åŠ›æœºåˆ¶.

ç”¨$X=[x_1,\cdots,x_N]\in\mathbb{R}^{D\times N}$ è¡¨ç¤º$N$ç»„è¾“å…¥ä¿¡æ¯ï¼Œå…¶ä¸­$D$ ç»´å‘é‡ $\boldsymbol{x}_n\in$ $\mathbb{R}^D,n\in[1,N]$è¡¨ç¤ºä¸€ç»„è¾“å…¥ä¿¡æ¯.ä¸ºäº†èŠ‚çœè®¡ç®—èµ„æºï¼Œä¸éœ€è¦å°†æ‰€æœ‰ä¿¡æ¯éƒ½è¾“å…¥ç¥ç»ç½‘ç»œï¼Œåªéœ€è¦ä»$\boldsymbol X$ ä¸­é€‰æ‹©ä¸€äº›å’Œä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯.æ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š

1. ä¸€æ˜¯åœ¨æ‰€æœ‰è¾“å…¥ä¿¡æ¯ä¸Š**è®¡ç®—æ³¨æ„åŠ›åˆ†å¸ƒ**ï¼›
2. äºŒæ˜¯æ ¹æ®æ³¨æ„åŠ›åˆ†å¸ƒæ¥**è®¡ç®—è¾“å…¥ä¿¡æ¯çš„åŠ æƒå¹³å‡**.

ä¸ºäº†ä»$N$ä¸ªè¾“å…¥å‘é‡$[\boldsymbol x_1,\cdotp\cdotp\cdotp,\boldsymbol x_N]$ä¸­é€‰æ‹©å‡ºå’ŒæŸä¸ªç‰¹å®šä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªå’Œä»»åŠ¡ç›¸å…³çš„è¡¨ç¤ºï¼Œç§°ä¸º**æŸ¥è¯¢å‘é‡(Query Vector)**, å¹¶é€šè¿‡ä¸€ä¸ªæ‰“åˆ†å‡½æ•°æ¥è¡¡**é‡æ¯ä¸ªè¾“å…¥å‘é‡å’ŒæŸ¥è¯¢å‘é‡ä¹‹é—´çš„ç›¸å…³æ€§**.
ç»™å®šä¸€ä¸ªå’Œä»»åŠ¡ç›¸å…³çš„æŸ¥è¯¢å‘é‡$\boldsymbol q$,æˆ‘ä»¬ç”¨æ³¨æ„åŠ›å˜é‡$z\in[1,N]$æ¥è¡¨ç¤ºè¢«é€‰æ‹©ä¿¡æ¯çš„ç´¢å¼•ä½ç½®ï¼Œå³$z=n$ è¡¨ç¤ºé€‰æ‹©äº†ç¬¬$n$ ä¸ªè¾“å…¥å‘é‡.ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œæˆ‘ä»¬é‡‡ç”¨ä¸€ç§â€œè½¯æ€§â€çš„ä¿¡æ¯é€‰æ‹©æœºåˆ¶.é¦–å…ˆè®¡ç®—åœ¨ç»™å®š$q$å’Œ$X$ä¸‹ï¼Œé€‰æ‹©ç¬¬$n$ä¸ªè¾“å…¥å‘é‡çš„æ¦‚ç‡$\alpha_n$,

$$
\begin{aligned}\alpha_{n}&=p(z=n|X,\boldsymbol{q})\\&=\operatorname{softmax}\left(s(\boldsymbol{x}_n,\boldsymbol{q})\right)\\&=\frac{\exp\left(s(\boldsymbol{x}_n,\boldsymbol{q})\right)}{\sum_{j=1}^N\exp\left(s(\boldsymbol{x}_j,\boldsymbol{q})\right)},\end{aligned}
$$

å…¶ä¸­$\alpha_n$ ç§°ä¸º**æ³¨æ„åŠ›åˆ†å¸ƒ( Attention Distribution)**,$s(\boldsymbol x,\boldsymbol{q})$ ä¸º**æ³¨æ„åŠ›æ‰“åˆ†å‡½æ•°.**

> æ³¨æ„åŠ›æ‰“åˆ†å‡½æ•°$\mathbf{s}(\mathbf{x},\mathbf{q})$ï¼šè®¡ç®—è¾“å…¥å‘é‡å’ŒæŸ¥è¯¢å‘é‡ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå¸¸ç”¨å¦‚ä¸‹æ¨¡å‹
>
> $$
> \begin{aligned}&\bullet\text{ åŠ æ€§æ¨¡å‹: }\mathbf{s}(\mathbf{x},\mathbf{q})=\mathbf{v}^{T}\mathrm{tanh}(\mathbf{W}\mathbf{x}+\mathbf{U}\mathbf{q}).\\&\bullet\text{ ç‚¹ç§¯æ¨¡å‹: }\mathbf{s}(\mathbf{x},\mathbf{q})=\mathbf{x}^{T}\mathbf{q}.\\&\bullet\text{ ç¼©æ”¾ç‚¹ç§¯æ¨¡å‹: }\mathbf{s}(\mathbf{x},\mathbf{q})=\frac{\mathbf{x}^{T}\mathbf{q}}{\sqrt{D}}.\\&\bullet\text{ åŒçº¿æ€§æ¨¡å‹: }\mathbf{s}(\mathbf{x},\mathbf{q})=\mathbf{x}^{T}\mathbf{W}\mathbf{q}.\end{aligned}
> $$
>
> è¿™é‡Œ$\mathbf{W},\mathbf{U},\mathbf{v}$ä¸ºå¯å­¦ä¹ çš„å‚æ•°ï¼Œ$D$ä¸ºè¾“å…¥å‘é‡çš„ç»´åº¦.

**Note:**

1. åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œ$h_1,h_2,h_3,h_4$å°±æ˜¯è¾“å…¥å‘é‡$X$;
2. $h'_1,h'_2,h'_3$å°±æ˜¯æŸ¥è¯¢å‘é‡$q$;
3. $a_{ij}$å°±æ˜¯æ³¨æ„åŠ›åˆ†å¸ƒï¼Œè¿™é‡Œæˆ‘ä»¬ç»™å‡ºäº†æ³¨æ„åŠ›åˆ†å¸ƒæ€ä¹ˆè®¡ç®—çš„.

å¾—åˆ°æ³¨æ„åŠ›åˆ†å¸ƒåï¼Œå¯¹è¾“å…¥å‘é‡åŠ æƒå¹³å‡å¯ä»¥å¾—åˆ°attentionå€¼ï¼š

$$
\begin{aligned}\operatorname{att}(X,\boldsymbol{q})&=\sum_{n=1}^N\alpha_nx_n,\\&=\mathbb{E}_{z\sim p(z|X,\boldsymbol{q})}[x_z].\end{aligned}
$$

ä¸‹å›¾ï¼ˆaï¼‰æ¸…æ™°çš„æè¿°äº†attentionçš„è®¡ç®—è¿‡ç¨‹.

![æˆªå±2024-07-15 18.28.38](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407151828526.png)

æ›´ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é”®å€¼å¯¹( key-value pair)æ ¼å¼æ¥è¡¨ç¤ºè¾“å…¥ä¿¡æ¯ï¼Œå…¶ä¸­â€œé”®â€ç”¨æ¥è®¡ç®—æ³¨æ„åŠ›åˆ†å¸ƒ$\alpha_n$,â€œå€¼â€ç”¨æ¥è®¡ç®—èšåˆä¿¡æ¯.ç”¨$\left(\boldsymbol{K},\boldsymbol{V}\right)=\left[\left(\boldsymbol{k}_1,\boldsymbol{\upsilon}_1\right),\cdots,\left(\boldsymbol{k}_N,\boldsymbol{\upsilon}_N\right)\right]$è¡¨ç¤º$N$ç»„è¾“å…¥ä¿¡æ¯ï¼Œç»™å®šä»»åŠ¡ç›¸å…³çš„æŸ¥è¯¢å‘é‡$q$æ—¶ï¼Œæ³¨æ„åŠ›å‡½æ•°ä¸º

$$
\begin{aligned}\operatorname{att}\Big((\boldsymbol{K},\boldsymbol{V}),\boldsymbol{q}\Big)&=\sum_{n=1}^N\alpha_n\boldsymbol{v}_n,\\&=\sum_{n=1}^N\frac{\exp\left(s(\boldsymbol{k}_n,\boldsymbol{q})\right)}{\sum_j\exp\left(s(\boldsymbol{k}_j,\boldsymbol{q})\right)}\boldsymbol{v}_n,\end{aligned}
$$

å…¶ä¸­ $s(\boldsymbol{k}_n,\boldsymbol{q})$ ä¸ºæ‰“åˆ†å‡½æ•°.å›¾8.1ç»™å‡ºé”®å€¼å¯¹æ³¨æ„åŠ›æœºåˆ¶çš„ç¤ºä¾‹.å½“$K=V$æ—¶ï¼Œé”®å€¼å¯¹æ¨¡å¼å°±ç­‰ä»·äºæ™®é€šçš„æ³¨æ„åŠ›æœºåˆ¶.

## ä¸‰ã€è‡ªæ³¨æ„åŠ›æ¨¡å‹(Self-Attention)

ç”±é”®å€¼å¯¹æ³¨æ„åŠ›æ¨¡å¼æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å¼•å‡º `è‡ªæ³¨æ„åŠ›æ¨¡å‹`çš„æ¦‚å¿µï¼Œè¯¥æ¨¡å‹é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥å»ºç«‹è¾“å…¥åºåˆ—é•¿è·ç¦»ä¾èµ–å…³ç³»ã€‚è‡ªæ³¨æ„åŠ›æ¨¡å‹è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æˆªå±2024-07-15 18.54.23](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407151855074.png)

ğŸ”¥Note:

1. $X$ä¸ºè¾“å…¥çŸ©é˜µï¼›
2. $W^Qã€W^Kã€W^V$æ˜¯å¯å­¦ä¹ çš„å‚æ•°çŸ©é˜µï¼›
3. æœ€åå¾—åˆ°çš„$Z$ä¸ºattentionå€¼çŸ©é˜µ;

> ä¸ºä»€ä¹ˆå«è‡ªæ³¨æ„åŠ›æ¨¡å‹å‘¢ï¼Ÿ**å› ä¸ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡ŒQã€Kã€Véƒ½æ˜¯ç”±$X$é€šè¿‡ä¸€ä¸ªçº¿æ€§å˜æ¢æŠ•å½±å¾—åˆ°çš„ï¼Œè€ŒçŸ©é˜µ$W$æ˜¯å¯å­¦ä¹ çš„ï¼Œæ‰€ä»¥ç”±$X$åˆ°$Z$çš„æ˜ å°„æƒé‡æ˜¯å¯å­¦ä¹ çš„ï¼Œæ˜¯åŠ¨æ€è°ƒæ•´çš„ã€‚**
> {: .prompt-tip}

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²è¡¨ç¤ºå½“å‰çš„è¯ï¼Œè“è‰²é˜´å½±è¡¨ç¤ºä¸çº¢è‰²è¯çš„ç›¸å…³ç¨‹åº¦ï¼Œé€šè¿‡è‡ªæ³¨æ„åŠ›æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨å­¦åˆ°æ¯ä¸ªè¯ä¸å‰é¢è¯çš„ç›¸å…³å…³ç³»ã€‚

![æˆªå±2024-07-15 19.02.19](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407151902576.png)

## å››ã€Self-Attentionæ¨¡å‹çš„å¤æ‚åº¦åˆ†æ

æ€»çš„æ¥è¯´ï¼Œè‡ªæ³¨æ„åŠ›æ¨¡å‹çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦ä¸**è¾“å…¥åºåˆ—é•¿åº¦$N$å‘ˆ2æ¬¡å…³ç³»**ï¼Œå¯ä»¥ä¸ä¸¥æ ¼çš„è¡¨ç¤ºä¸º$O(N^2)$.

### ï¼ˆ1ï¼‰æ—¶é—´å¤æ‚åº¦

![æˆªå±2024-07-21 19.28.20](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407211928934.png)

![æˆªå±2024-07-21 19.29.49](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407211929340.png)

### ï¼ˆ2ï¼‰ç©ºé—´å¤æ‚åº¦

![æˆªå±2024-07-21 19.30.31](https://aurora-pics.oss-cn-beijing.aliyuncs.com/Pic/202407211930137.png)

## å‚è€ƒèµ„æ–™

1. [æ·±åº¦å­¦ä¹ 500é—®](https://github.com/scutan90/DeepLearning-500-questions)
2. é‚±é”¡é¹ï¼Œç¥ç»ç½‘ç»œä¸æ·±åº¦å­¦ä¹ ï¼Œæœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ï¼Œhttps://nndl.github.io/, 2020.
